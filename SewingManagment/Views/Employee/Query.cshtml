@using Microsoft.AspNetCore.Html
@using SewingManagment.Enums
@using SewingManagment.Extensions
@using SewingManagment.UI
@using SewingManagment.ViewModels
@model (PaginatedViewModel<Employee> ViewModel, TableConfig Config)
@{
    /* 整個 View 的共用資訊，例如標題、說明文字、頁面層級設定等 */
    ViewData["Title"] = "員工資料列表";
}
<link rel="stylesheet" href="~/css/employee.css" />

@* 搜尋表單 *@
<ul class="nav nav-pills nav-fill" id="searchNav" role="tablist">
    <li class="nav-item m-0" role="presentation">
        <button class="nav-link active" id="simple-tab" data-bs-toggle="tab" data-bs-target="#simple-search"
                type="button" role="tab" aria-controls="simple-search" aria-selected="true">簡易搜尋</button>
    </li>
    <li class="nav-item m-0" role="presentation">
        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-search"
                type="button" role="tab" aria-controls="advanced-search" aria-selected="false">進階搜尋</button>
    </li>
    
</ul>

<div class="tab-content bg-light-gray p-3">
    <div class="tab-pane fade show active" id="simple-search" role="tabpanel" aria-labelledby="simple-tab">
        <h4 class="mb-3">簡易搜尋</h4>
        <form asp-controller="Employee" asp-action="Query" method="post" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label" for="SortField">排序欄位</label>
                    <select class="form-select" id="SortField" name="SortField" asp-for="ViewModel.SortField"
                            asp-items="@(default(EmployeeEnums.EmployeeSortField).ToSelectList())">
                        <option value="">-- 請選擇排序欄位 --</option>
                    </select>
                </div>

                <div class="col-12 col-md-3">
                    <label class="form-label" for="SortDirection">排序方向</label>
                    <select class="form-select" id="SortDirection" name="SortDirection" asp-for="ViewModel.SortDirection">
                        <option value="ASC">升冪 ↑</option>
                        <option value="DESC">降冪 ↓</option>
                    </select>
                </div>

                <div class="col-12 col-md-5">
                    <label class="form-label" for="SearchTerm">搜尋關鍵字</label>
                    <input type="text" class="form-control" id="SearchTerm" name="SearchTerm" asp-for="ViewModel.SearchTerm"
                           placeholder="全文檢索" />
                </div>

                <input type="hidden" asp-for="ViewModel.PageNumber" value="1" />
                <input type="hidden" asp-for="ViewModel.PageSize" />

                <div class="col-12 d-flex gap-2">
                    <button class="btn btn-primary" type="submit">搜尋</button>
                    <button class="btn btn-outline-secondary" type="reset">清除</button>
                </div>
            </div>
        </form>
    </div>
    <div class="tab-pane fade" id="advanced-search" role="tabpanel" aria-labelledby="advanced-tab">
        <h4 class="mb-3">進階搜尋</h4>
        <p class="text-muted">這裡是進階搜尋的內容。</p>
    </div>
</div>

<div class="mt-3 pe-2 py-2 d-flex justify-content-end bg-light-gray">
    <a class="btn btn-primary px-4" asp-controller="Employee" asp-action="Create">新增</a>
</div>

@* LINQ 的 Cast<T>() 擴充方法，用來把集合中的元素轉型成特定型別。 *@
@await Html.PartialAsync("_Table", (Items: Model.ViewModel.Items.Cast<dynamic>(), Config: Model.Config))

@* pagination 元件 *@
<nav aria-label="員工分頁導航">
    <ul class="pagination justify-content-center">
        <li class="page-item @(Model.ViewModel.PageNumber <= 1 ? "disabled" : "")">
            <a class="page-link" href="#" onclick="submitForm(@(Model.ViewModel.PageNumber - 1))">上一頁</a>
        </li>
        @for (int i = 1; i <= Model.ViewModel.TotalPages; i++)
        {
            <li class="page-item @(i == Model.ViewModel.PageNumber ? "active" : "")">
                <a class="page-link" href="#" onclick="submitForm(@i)">@i</a>
            </li>
        }
        <li class="page-item @(Model.ViewModel.PageNumber >= Model.ViewModel.TotalPages ? "disabled" : "")">
            <a class="page-link" href="#" onclick="submitForm(@(Model.ViewModel.PageNumber + 1))">下一頁</a>
        </li>
    </ul>
</nav>

<form id="paginationForm" asp-controller="Employee" asp-action="Query" method="post" style="display:none;">
    <input type="hidden" name="SearchTerm" value="@Model.ViewModel.SearchTerm" />
    <input type="hidden" name="SearchField" value="@Model.ViewModel.SearchField" />
    <input type="hidden" name="PageNumber" id="pageNumberInput" value="@Model.ViewModel.PageNumber" />
    <input type="hidden" name="PageSize" value="@Model.ViewModel.PageSize" />
</form>
@* pagination 元件 *@

@if (TempData["Message"] != null)
{
    <p class="alert alert-success mt-2">@TempData["Message"]</p>
}

@section Scripts {
    <script>
        function submitForm(pageNumber) {
            document.getElementById('pageNumberInput').value = pageNumber;
            document.getElementById('paginationForm').submit();
        }

        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();

                const id = btn.getAttribute('data-id');
                if (!confirm(`確定要刪除 ID=${id} 的員工嗎？`)) return;

                const response = await fetch(`/Employee/Delete/${id}`, {
                    method: 'DELETE'
                });

                console.log('response',response)

                if (response.ok) {
                    alert('刪除成功');
                    // 重新載入頁面以更新列表，因為刪除可能會影響分頁
                    submitForm(@Model.ViewModel.PageNumber);
                } else {
                    alert('刪除失敗');
                }
            });
        });


        // 使用 Bootstrap Tabs，無需自訂分頁切換 JS
    </script>
}