@using Microsoft.AspNetCore.Html
@using SewingManagment.Enums
@using SewingManagment.Extensions
@using SewingManagment.UI
@using SewingManagment.ViewModels
@model (PaginatedViewModel<Employee> ViewModel, TableConfig Config)
@{
    /* 整個 View 的共用資訊，例如標題、說明文字、頁面層級設定等 */
    ViewData["Title"] = "員工資料列表";
}
@* @{
    /* _Table.cshtml 的設定 */
    var tableHeaders = new Dictionary<string, string>
    {
        { "Id", "工號" },
        { "Name", "姓名" },
        { "Gender", "性別" },
        { "Position", "職務" }
    };

    /* 定義欄位順序 */
    var tableColumns = new List<string> { "Id", "Name", "Gender", "Position" };

    /* 可選：設定每列的 class */
    Func<dynamic, string> tableRowClassFunc = e => e.Position == "03" ? "table-warning" : "";

    /*
     * 可選：設定操作按鈕
     * 使用 a 標籤而不是 button 標籤，因為 a 標籤可以傳遞 id
     */
    Func<dynamic, Microsoft.AspNetCore.Html.IHtmlContent> tableActionsFunc = e =>
    {
        var editUrl = $"/Employee/Edit/{e.Id}";
        return new HtmlString($@"
            <a class='btn btn-warning px-4' href='{editUrl}'>編輯</a>
            <a class='btn btn-danger px-4 btn-delete' data-id='{e.Id}'>刪除</a>
        ");
    };

    var tableViewData = new ViewDataDictionary(ViewData)
    {
        { "Headers", tableHeaders },
        { "Columns", tableColumns },
        { "RowClassFunc", tableRowClassFunc },
        { "ActionsFunc", tableActionsFunc }
    };
} *@

@* 搜尋表單 *@
<form asp-controller="Employee" asp-action="Query" method="post" class="mb-4">
    <div class="input-group">
        <select class="form-select" asp-for="ViewModel.SearchField"
                asp-items="@(default(EmployeeSearchField).ToSelectList())">
        </select>
        <input type="text" class="form-control" placeholder="搜尋內容..." name="SearchTerm" value="@Model.ViewModel.SearchTerm" />
        <input type="hidden" name="PageNumber" value="1" />
        <input type="hidden" name="PageSize" value="@Model.ViewModel.PageSize" />
        <button class="btn btn-outline-secondary" type="submit">搜尋</button>
    </div>
</form>

<div class="mb-4 d-flex justify-content-end">
    <a class="btn btn-primary px-4" asp-controller="Employee" asp-action="Create">新增</a>
</div>

@await Html.PartialAsync("_Table", Model)

@* pagination 元件 *@
<nav aria-label="員工分頁導航">
    <ul class="pagination justify-content-center">
        <li class="page-item @(Model.ViewModel.PageNumber <= 1 ? "disabled" : "")">
            <a class="page-link" href="#" onclick="submitForm(@(Model.ViewModel.PageNumber - 1))">上一頁</a>
        </li>
        @for (int i = 1; i <= Model.ViewModel.TotalPages; i++)
        {
            <li class="page-item @(i == Model.ViewModel.PageNumber ? "active" : "")">
                <a class="page-link" href="#" onclick="submitForm(@i)">@i</a>
            </li>
        }
        <li class="page-item @(Model.ViewModel.PageNumber >= Model.ViewModel.TotalPages ? "disabled" : "")">
            <a class="page-link" href="#" onclick="submitForm(@(Model.ViewModel.PageNumber + 1))">下一頁</a>
        </li>
    </ul>
</nav>

<form id="paginationForm" asp-controller="Employee" asp-action="Query" method="post" style="display:none;">
    <input type="hidden" name="SearchTerm" value="@Model.ViewModel.SearchTerm" />
    <input type="hidden" name="SearchField" value="@Model.ViewModel.SearchField" />
    <input type="hidden" name="PageNumber" id="pageNumberInput" value="@Model.ViewModel.PageNumber" />
    <input type="hidden" name="PageSize" value="@Model.ViewModel.PageSize" />
</form>
@* pagination 元件 *@

@if (TempData["Message"] != null)
{
    <p class="alert alert-success mt-2">@TempData["Message"]</p>
}

@section Scripts {
    <script>
        function submitForm(pageNumber) {
            document.getElementById('pageNumberInput').value = pageNumber;
            document.getElementById('paginationForm').submit();
        }

        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();

                const id = btn.getAttribute('data-id');
                if (!confirm(`確定要刪除 ID=${id} 的員工嗎？`)) return;

                const response = await fetch(`/Employee/Delete/${id}`, {
                    method: 'DELETE'
                });

                console.log('response',response)

                if (response.ok) {
                    alert('刪除成功');
                    // 重新載入頁面以更新列表，因為刪除可能會影響分頁
                    submitForm(@Model.ViewModel.PageNumber);
                } else {
                    alert('刪除失敗');
                }
            });
        });
    </script>
}