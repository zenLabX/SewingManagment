@using Microsoft.AspNetCore.Html
@using SewingManagment.Enums
@using SewingManagment.Extensions
@using SewingManagment.UI
@using SewingManagment.ViewModels
@model (PaginatedViewModel<Employee> ViewModel, TableConfig Config)
@{
    /* 整個 View 的共用資訊，例如標題、說明文字、頁面層級設定等 */
    ViewData["Title"] = "員工資料列表";
}
<link rel="stylesheet" href="~/css/employee.css" />

@* 搜尋表單 *@
<ul class="nav nav-pills nav-fill" id="searchNav">
    <li class="nav-item m-0">
        <a class="nav-link active" data-target="simple-search" href="#">簡易搜尋</a>
    </li>
    <li class="nav-item m-0">
        <a class="nav-link" data-target="advanced-search" href="#">進階搜尋</a>
    </li>
</ul>

<div class="tab-content bg-light-gray">
    <div id="simple-search">
        <h4>簡易搜尋</h4>
        <form asp-controller="Employee" asp-action="Query" method="post" class="mb-4">
            <div class="input-group">
                <!-- 排序欄位 -->
                <select class="form-select" name="SortField" asp-for="ViewModel.SortField"
                        asp-items="@(default(EmployeeEnums.EmployeeSortField).ToSelectList())">
                    <option value="">-- 請選擇排序欄位 --</option>
                </select>

                <!-- 排序方向 -->
                <select class="form-select" name="SortDirection">
                    <option value="ASC" selected="@("ASC" == Model.ViewModel.SortDirection)">升冪 ↑</option>
                    <option value="DESC" selected="@("DESC" == Model.ViewModel.SortDirection)">降冪 ↓</option>
                </select>

                <!-- 搜尋欄 -->
                <input type="text" class="form-control" placeholder="全文檢索"
                       name="SearchTerm" value="@Model.ViewModel.SearchTerm" />

                <input type="hidden" name="PageNumber" value="1" />
                <input type="hidden" name="PageSize" value="@Model.ViewModel.PageSize" />

                <button class="btn btn-outline-secondary" type="submit">搜尋</button>
            </div>
        </form>
    </div>
    <div id="advanced-search" style="display:none;">
        <h4>進階搜尋</h4>
        <p>這裡是進階搜尋的內容。</p>
    </div>
</div>

<div class="mb-4 d-flex justify-content-end">
    <a class="btn btn-primary px-4" asp-controller="Employee" asp-action="Create">新增</a>
</div>

@* LINQ 的 Cast<T>() 擴充方法，用來把集合中的元素轉型成特定型別。 *@
@await Html.PartialAsync("_Table", (Items: Model.ViewModel.Items.Cast<dynamic>(), Config: Model.Config))

@* pagination 元件 *@
<nav aria-label="員工分頁導航">
    <ul class="pagination justify-content-center">
        <li class="page-item @(Model.ViewModel.PageNumber <= 1 ? "disabled" : "")">
            <a class="page-link" href="#" onclick="submitForm(@(Model.ViewModel.PageNumber - 1))">上一頁</a>
        </li>
        @for (int i = 1; i <= Model.ViewModel.TotalPages; i++)
        {
            <li class="page-item @(i == Model.ViewModel.PageNumber ? "active" : "")">
                <a class="page-link" href="#" onclick="submitForm(@i)">@i</a>
            </li>
        }
        <li class="page-item @(Model.ViewModel.PageNumber >= Model.ViewModel.TotalPages ? "disabled" : "")">
            <a class="page-link" href="#" onclick="submitForm(@(Model.ViewModel.PageNumber + 1))">下一頁</a>
        </li>
    </ul>
</nav>

<form id="paginationForm" asp-controller="Employee" asp-action="Query" method="post" style="display:none;">
    <input type="hidden" name="SearchTerm" value="@Model.ViewModel.SearchTerm" />
    <input type="hidden" name="SearchField" value="@Model.ViewModel.SearchField" />
    <input type="hidden" name="PageNumber" id="pageNumberInput" value="@Model.ViewModel.PageNumber" />
    <input type="hidden" name="PageSize" value="@Model.ViewModel.PageSize" />
</form>
@* pagination 元件 *@

@if (TempData["Message"] != null)
{
    <p class="alert alert-success mt-2">@TempData["Message"]</p>
}

@section Scripts {
    <script>
        function submitForm(pageNumber) {
            document.getElementById('pageNumberInput').value = pageNumber;
            document.getElementById('paginationForm').submit();
        }

        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();

                const id = btn.getAttribute('data-id');
                if (!confirm(`確定要刪除 ID=${id} 的員工嗎？`)) return;

                const response = await fetch(`/Employee/Delete/${id}`, {
                    method: 'DELETE'
                });

                console.log('response',response)

                if (response.ok) {
                    alert('刪除成功');
                    // 重新載入頁面以更新列表，因為刪除可能會影響分頁
                    submitForm(@Model.ViewModel.PageNumber);
                } else {
                    alert('刪除失敗');
                }
            });
        });


        // 切換搜尋顯示區塊
        const navLinks = document.querySelectorAll('#searchNav .nav-link');
        const tabContents = document.querySelectorAll('.tab-content > div');

        navLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();

            // 切換 active
            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            // 顯示對應區塊
            const target = this.dataset.target;
            tabContents.forEach(tc => {
              if (tc.id === target) {
                tc.style.display = 'block';
              } else {
                tc.style.display = 'none';
              }
            });
          });
        });
    </script>
}